<script>

  /**
   * Run initializations on page load.
   */
   window.onload = function() {
       initialize();
   };

   window.onbeforeunload = function () {
       return "are you sure you want to leave?";
   };

   function initialize() {
       initializeButtons();
       initializeBoard();
       continuouslyShowAllPlayers();
   }

  function initializeButtons() {

    getPlayButton().addEventListener("click", function(){
       enterGame();
    });

    const quitButton = getQuitButton();
    quitButton.disabled = true;
    quitButton.addEventListener("click", function(){
      leaveGame();
    });
  }

  function continuouslyShowAllPlayers() {
      showAllPlayers();
      setTimeout(continuouslyShowAllPlayers, 1000);
  }

  function showAllPlayers() {
    google.script.run
        .withSuccessHandler(populatePlayerPairsList)
        .withFailureHandler(showError)
        .getPairedPlayers();
  }

  /**
   * @param players list of currently available or active players.
   */
  function populatePlayerPairsList(playerPairs) {
      var container = document.querySelector("#players");
      removeChildren(container);

      for (var i = 0; i < playerPairs.length; i++) {
          const playerLi = document.createElement("li");
          var ppair = playerPairs[i]
          playerLi.textContent = ppair[0] + " vs " + ppair[1];
          container.appendChild(playerLi);
      }
  }

  function enterGame() {
      document.querySelector("#directions").textContent = 'Waiting for opponent...';
      google.script.run
        .withSuccessHandler(waitForOpponent)
        .withFailureHandler(showError)
        .newPlayerEnters();

      getPlayButton().disabled = true;
      getQuitButton().disabled = false;
  }

  function leaveGame() {
      google.script.run
        .withFailureHandler(showError)
        .playerLeaves();

      getPlayButton().disabled = false;
      getQuitButton().disabled = true;
      document.querySelector("#directions").textContent = 'You forfeit!';
  }

  /**
   * Either the other player has not yet entered, or we are the second player and should start game immediately.
   */
  function waitForOpponent(players) {
      if (players.player2) {
           gameStarted(players);
      }
      else {
           google.script.run
              .withSuccessHandler(waitForOpponent)
              .withFailureHandler(showError)
              .checkForOpponent();
      }
  }

  function gameStarted(players) {
      var user = document.querySelector("#userid").textContent;
      // If no second player for that last one, then no longer waiting
      var directionsEl = document.querySelector("#directions");

      var directions = players.player1 == user ?
        "Found player for you to play. You will be playing X against <b>" + players.player2 + "</b>." :
        "You will be playing O against <b>" + players.player1 + "</b>.";

      directionsEl.innerHTML = directions;
  }

  function getPlayButton() {
    return document.querySelector("#play");
  }

  function getQuitButton() {
    return document.querySelector("#quit");
  }

</script>
