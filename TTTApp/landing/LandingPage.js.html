<script>
  // Global variables for this player
  var thisPlayersMove = false;   // When true, the player is allowed to move.
  var thisPlayersSymbol = null;  // Will be either X or O when a game is ACTIVE
  var thisGameId = null;         // unique ID of the current game (once it starts)

  /**
   * Run initializations on page load.
   */
   window.onload = function() {
       initialize();
   };

   window.onbeforeunload = function () {
       return "are you sure you want to leave?";
   };

   function initialize() {
       initializeButtons();
       //continuouslyShowAllPlayers();
   }

  function initializeButtons() {
    getPlayButton().addEventListener("click", function(){
       enterGame();
    });

    const quitButton = getQuitButton();
    quitButton.disabled = true;
    quitButton.addEventListener("click", function(){
      leaveGameBeforeOver();
    });
  }

  function enterGame() {
      getDirectionsEl().textContent = 'Waiting for opponent...';
      google.script.run
        .withSuccessHandler(waitForOpponent)
        .withFailureHandler(showError)
        .newPlayerEnters();

      getPlayButton().disabled = true;
      getQuitButton().disabled = false;
  }

  function leaveGameBeforeOver() {
    getDirectionsEl().textContent = 'You forfeit!';
  }

  function leaveGame() {
      google.script.run
        .withFailureHandler(showError)
        .playerLeaves();

      getPlayButton().disabled = false;
      getQuitButton().disabled = true;
      thisPlayersMove = false;
      thisPlayersSymbol = null;
  }

  /**
   * Either the other player has not yet entered, or we are the second player and should start game immediately.
   */
  function waitForOpponent(players) {
      if (players.player2) {
          gameStarted(players);
      }
      else {
          google.script.run
              .withSuccessHandler(waitForOpponent)
              .withFailureHandler(showError)
              .checkForOpponent();
      }
  }

  function gameStarted(players) {
      var user = document.querySelector("#userid").textContent;
      var directionsEl = getDirectionsEl();

      var isPlayerX = players.player1 == user;
      thisPlayersSymbol = isPlayerX ? 'X' : 'O';
      thisPlayersMove = isPlayerX;
      thisGameId = players.gameId;

      var directions = isPlayerX ?
        "Found player for you to play. You will be playing X against <b>" + players.player2 + "</b>." :
        "You will be playing O against <b>" + players.player1 + "</b>.";

      directionsEl.innerHTML = directions;
      initializeBoard();
  }

  function getDirectionsEl() {
      return document.querySelector("#directions");
  }

  function getPlayButton() {
    return document.querySelector("#play");
  }

  function getQuitButton() {
    return document.querySelector("#quit");
  }

</script>
